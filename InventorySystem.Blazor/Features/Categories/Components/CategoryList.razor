@using InventorySystem.Blazor.Features.Categories.Contracts
@using System.Linq.Expressions
@inject InventorySystem.Blazor.Features.Categories.Services.ProductCategoriesApiClient Api

@if (_loading)
{
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        <MudText>Cargando...</MudText>
    </MudStack>
}
else if (_error is not null)
{
    <MudAlert Severity="Severity.Error">@_error</MudAlert>
}
else if (_categories.Count == 0)
{
    <MudAlert Severity="Severity.Warning">No hay categorías.</MudAlert>
}
else
{
    <MudSelect T="Guid?"
               Label="Selecciona una categoría"
               Variant="Variant.Outlined"
               Margin="Margin.Dense"
               FullWidth="true"
               Clearable="true"
               ToStringFunc="@(id => id is null ? string.Empty : (_nameById.TryGetValue(id.Value, out var name) ? name : id.Value.ToString()))"
               Value="SelectedCategoryId"
               ValueChanged="OnSelectedChanged"
               ValueExpression="SelectedCategoryIdExpression">

        @foreach (var c in _categories)
        {
            <MudSelectItem T="Guid?" Value="@c.Id">
                @c.CategoryName
            </MudSelectItem>
        }
    </MudSelect>
}

@code {
    private List<ProductCategoryResponse> _categories = [];
    private bool _loading;
    private string? _error;
    private Dictionary<Guid, string> _nameById = new();

    [Parameter] public Guid? SelectedCategoryId { get; set; }
    [Parameter] public EventCallback<Guid?> SelectedCategoryIdChanged { get; set; }
    [Parameter] public Expression<Func<Guid?>>? SelectedCategoryIdExpression { get; set; }

    protected override async Task OnInitializedAsync()
        => await ReloadAsync();

    public async Task ReloadAsync()
    {
        _loading = true;

        try
        {
            _categories = (await Api.GetAllAsync()).ToList();
            _nameById = _categories.ToDictionary(c => c.Id, c => c.CategoryName);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnSelectedChanged(Guid? value)
    {
        SelectedCategoryId = value;
        await SelectedCategoryIdChanged.InvokeAsync(value);
    }
}


@using InventorySystem.Blazor.Features.Brands.Contracts
@using System.Linq.Expressions
@inject InventorySystem.Blazor.Features.Brands.Services.ProductBrandsApiClient Api

@if (_loading)
{
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        <MudText>Cargando...</MudText>
    </MudStack>
}
else if (_error is not null)
{
    <MudAlert Severity="Severity.Error">@_error</MudAlert>
}
else if (_brands.Count == 0)
{
    <MudAlert Severity="Severity.Warning">No hay Marcas.</MudAlert>
}
else
{
    <MudSelect T="Guid?"
               Label="Selecciona una Marca"
               Variant="Variant.Outlined"
               Margin="Margin.Dense"
               FullWidth="true"
               Clearable="true"
               ToStringFunc="@(id => id is null ? string.Empty : (_nameById.TryGetValue(id.Value, out var name) ? name : id.Value.ToString()))"
               Value="SelectedBrandId"
               ValueChanged="OnSelectedChanged"
               ValueExpression="SelectedBrandIdExpression">

        @foreach (var c in _brands)
        {
            <MudSelectItem T="Guid?" Value="@c.Id">
                @c.BrandName
            </MudSelectItem>
        }
    </MudSelect>
}

@code {
    private List<ProductBrandResponse> _brands = [];
    private bool _loading;
    private string? _error;
    private Dictionary<Guid, string> _nameById = new();

    [Parameter] public Guid? SelectedBrandId { get; set; }
    [Parameter] public EventCallback<Guid?> SelectedBrandIdChanged { get; set; }
    [Parameter] public Expression<Func<Guid?>>? SelectedBrandIdExpression { get; set; }

    protected override async Task OnInitializedAsync()
        => await ReloadAsync();

    public async Task ReloadAsync()
    {
        _loading = true;

        try
        {
            _brands = (await Api.GetAllAsync()).ToList();
            _nameById = _brands.ToDictionary(c => c.Id, c => c.BrandName);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnSelectedChanged(Guid? value)
    {
        SelectedBrandId = value;
        await SelectedBrandIdChanged.InvokeAsync(value);
    }
}